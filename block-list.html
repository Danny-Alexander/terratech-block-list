<!DOCTYPE html>
<html>

<head>	

	<!-- DataTables with Foundation styling and most options https://datatables.net/download/index (via DataTables CDN)-->
	<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/zf-6.4.3/jq-3.3.1/jszip-2.5.0/dt-1.10.18/b-1.5.6/b-colvis-1.5.6/b-flash-1.5.6/b-html5-1.5.6/b-print-1.5.6/cr-1.5.0/fc-3.2.5/fh-3.1.4/r-2.2.2/rg-1.1.0/datatables.min.css"/>

	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/pdfmake.min.js"></script>
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/vfs_fonts.js"></script>
	<script type="text/javascript" src="https://cdn.datatables.net/v/zf-6.4.3/jq-3.3.1/jszip-2.5.0/dt-1.10.18/b-1.5.6/b-colvis-1.5.6/b-flash-1.5.6/b-html5-1.5.6/b-print-1.5.6/cr-1.5.0/fc-3.2.5/fh-3.1.4/r-2.2.2/rg-1.1.0/datatables.min.js"></script>
		
	<!-- Font-awesome for child details button icons -->
	<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet"
		integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
	
	<!-- Local scripts -->
	<script type="text/javascript" src="scripts/version-selection.js"></script>

	<style>
		/* Colouring for child details button */
		td.details-control {
			text-align: center;
			color: forestgreen;
			cursor: pointer;
		}

		tr.shown td.details-control {
			text-align: center;
			color: red;
		}
	</style>

	<meta charset=utf-8 />

</head>

<body>
	<div style="width:100%">
		<table style="margin:0">
			<th align="left" width="20%"><input id="globalSearch" placeholder="Search everything" style="padding:8px; width:100%"></th>
			<th align="left" width="10%"><div id="rowCountControls" style="display: inline;" ></div></th>
			<th width="40%">
				<h3 style="display: inline">TerraTech:</h3>
				<select id="version-dropdown" style="width: auto">
				</select>
				<h3 style="display: inline;">  Blocks List</h3>
				<span>v0.1.5</span>
			</th>
			<th align="right" width="10%"></th>
			<th id="exportControls" align="right" width="20%"></th>
		</table>
	</div>
	<div class="container">
		<table id="blocks-table" class="display" style="width:100%">
		</table>
	</div>
	<script>

		/* Formatting function for row details */
		function format ( d ) {
			// `d` is the original data object for the row
			return '<table cellpadding="5" cellspacing="0" border="0" style="padding-left:50px;">'+
				'<tr style="background-color: #ffffff;">'+
					'<td>Description:</td>'+
					'<td>'+d.description+'</td>'+
				'</tr>'+
				'<tr style="background-color: #ffffff;">'+
					'<td>ID:</td>'+
					'<td>'+d.id+'</td>'+
				'</tr>'+
				'<tr style="background-color: #ffffff;">'+
					'<td>Resource name:</td>'+
					'<td>'+d.resource_name+'</td>'+
				'</tr>'+
				'<tr style="background-color: #ffffff;">'+
					'<td>Enum ID:</td>'+
					'<td>'+d.enum_id+'</td>'+
				'</tr>'+
			'</table>';
		}

		$(document).ready(function () {

			populateVersionDropdown();

			// Add search text input to each non-blank column
			$('#blocks-table tfoot th').each( function () {
				if ($(this).text()) {
					var title = $(this).text();
					$(this).html( '<input type="text" placeholder="Search '+title+'" />' );
				}
			} );

			var table = $('#blocks-table').DataTable({

				// Data is loaded by version dropdown change event
				ajax: '',

				processing: true,

				// Allow changing the column order
				colReorder: true,

				// Enable optimising the table's layout for different screen sizes https://datatables.net/extensions/responsive/
				responsive: true,

				// Fix table header to top of window when scrolling down
				fixedHeader: true,

				// Enable buttons to copy and export data
				buttons: [
					// Add column visibility (menu with button to toggle visibility for each column)
					'colvis',
					// Add buttons to export/save the data in various formats
					'copy', 'csv', 'excel', 'pdf'
				],

				// Display buttons with filter control (search). 
				// Also determines the page layout: https://datatables.net/reference/option/dom
				dom: 'lBrtip',

				lengthMenu: [ [10, 25, 50, 100, -1], [10, 25, 50, 100, "All"] ],

				// Correlate data elements to columns define above (order specific)
				columns: [
					{
						"className": 'details-control',
						"orderable": false,
						"data": null,
						"defaultContent": '',
						"render": function () {
							return '<i class="fa fa-plus-square" aria-hidden="true"></i>';
						},
						width: "15px"
					},
					{
						"title": "Name",
						"data": "block"
					},
					{
						"title": "Category", 
						"data": "category"
					},
					{
						"title": "Corp", 
						"data": "corp"
					},
					{
						"title": "Grade", 
						"data": "grade"
					},
					{
						"title": "Price", 
						"data": "price",
						"render": function (data, type, row, meta) {
							return type === 'display' ?
								data.toLocaleString() + ' ฿฿' :
								data;
						}
					},
					{
						"title": "Health", 
						"data": "health",
						"render": function (data, type, row, meta) {
							return type === 'display' ?
								data.toLocaleString() :
								data;
						}
					},
					{
						"title": "Mass", 
						"data": "mass",
						"render": function (data, type, row, meta) {
							return type === 'display' ?
								data.toLocaleString() :
								data;
						}
					},
					{
						"title": "Description", 
						"data": "description",
						"render": function (data, type, row, meta) {
							return type === 'display' && data.length > 12 ?
								'<span title="' + data + '">' + data.substr(0, 10) + '...</span>' :
								data;
						}
					}
				]
			});

			// Label the column visibility button for row details column
			table.button('0-0').text('*Show/Hide Details*');

			// Add event listener for opening and closing details
			$('#version-dropdown').on('change', function () {
				// Change the data source to the blocks.json for new version and refresh
				table.ajax.url($(this).val()).load();
			});

			// Add event listener for opening and closing details
			$('#blocks-table tbody').on('click', 'td.details-control', function () {
				var tr = $(this).closest('tr');
				var tdi = tr.find("i.fa");
				var row = table.row(tr);

				// Toggle details icon image
				tdi.toggleClass('fa-minus-square');
				tdi.toggleClass('fa-plus-square');

				// Toggle details icon colour
				tr.toggleClass('shown')

				if (row.child.isShown()) {
					// This row is already open - close it
					row.child.hide();
				}
				else {
					// Open this row
					row.child(format(row.data())).show();
				}
			});
			
			// Hide default search
			$('#blocks-table_filter').hide();

			// Add event listener for new global search change
			$('#globalSearch').on('keyup', function() {
				$('#blocks-table')
					.DataTable()
					.search($('#globalSearch').val(), true)
					.draw();
			});

			// Format and move individual column search inputs before table header
			{
				let r = $('#blocks-table tfoot tr');
				r.find('th').each(function () {
					$(this).css('padding', 8);
				});
				r.find('th input').each(function () {
					$(this).css('margin', 0);
				});
				$('#blocks-table thead').prepend(r);
			}

			// Add event listener for individual column search change
			table.columns().every( function () {
				var thisColumn = this;
				
				$( 'input', this.footer() ).on( 'keyup change clear', function () {
					// Apply the search when input value changes
					if ( thisColumn.search() !== this.value ) {
						thisColumn
							.search( this.value, true )
							.draw();
					}
				} );
			} );

			// Move export buttons
			$('#blocks-table_wrapper div.dt-buttons').appendTo('#exportControls');
			$('#exportControls div').css('margin', 0);
			
			// Move row count control
			$('#blocks-table_length').find('select')
				.css('width', 'auto')
				.css('padding', 8)
				.css('margin', 0);
			$('#blocks-table_length').appendTo('#rowCountControls');
		});
	</script>
</body>

</html>